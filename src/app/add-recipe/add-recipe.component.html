<section class="add-recipe">
  <div class="add-recipe__card">
    <header class="add-recipe__header">
      <div>
        <p class="add-recipe__eyebrow">Nuova ricetta</p>
        <h1 class="add-recipe__title">Crea un piatto</h1>
        <p class="add-recipe__subtitle">
          Aggiungi un nome, una descrizione e un’immagine per ispirare i tuoi utenti.
        </p>
      </div>
      <!-- <button class="add-recipe__chip" type="button">
        <span class="add-recipe__chip-icon" aria-hidden="true">＋</span>
        <span>Ingredienti</span>
      </button> -->
    </header>

    <form class="add-recipe__form" [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="add-recipe__grid">
        <label class="add-recipe__field">
          <span class="add-recipe__label">Nome ricetta</span>
          <input
            class="add-recipe__input"
            [class.add-recipe__input--invalid]="
              form.controls.recipeName.invalid &&
              (form.controls.recipeName.touched || form.controls.recipeName.dirty)
            "
            type="text"
            name="name"
            placeholder="Es. Lasagne al ragù"
            formControlName="recipeName"
          />
          @if (
            form.controls.recipeName.invalid &&
            (form.controls.recipeName.touched || form.controls.recipeName.dirty)
          ) {
            <span class="add-recipe__error">Il nome della ricetta è obbligatorio.</span>
          }
        </label>

        <label class="add-recipe__field">
          <span class="add-recipe__label">URL immagine</span>
          <input
            class="add-recipe__input"
            [class.add-recipe__input--invalid]="
              form.controls.recipeImg.invalid &&
              (form.controls.recipeImg.touched || form.controls.recipeImg.dirty)
            "
            type="url"
            name="imgUrl"
            placeholder="https://..."
            formControlName="recipeImg"
          />
          @if (
            form.controls.recipeImg.invalid &&
            (form.controls.recipeImg.touched || form.controls.recipeImg.dirty)
          ) {
            <span class="add-recipe__error">L'URL dell'immagine è obbligatorio.</span>
          }
        </label>

        <label class="add-recipe__field add-recipe__field--full">
          <span class="add-recipe__label">Descrizione</span>
          <textarea
            class="add-recipe__textarea"
            [class.add-recipe__textarea--invalid]="
              form.controls.recipeDescription.invalid &&
              (form.controls.recipeDescription.touched || form.controls.recipeDescription.dirty)
            "
            name="description"
            rows="3"
            placeholder="Scrivi una descrizione breve e invitante..."
            formControlName="recipeDescription"
          ></textarea>
          @if (
            form.controls.recipeDescription.invalid &&
            (form.controls.recipeDescription.touched || form.controls.recipeDescription.dirty)
          ) {
            <span class="add-recipe__error">La descrizione è obbligatoria.</span>
          }
        </label>

        <label class="add-recipe__field">
          <span class="add-recipe__label">Porzioni</span>
          <input
            class="add-recipe__input"
            [class.add-recipe__input--invalid]="
              form.controls.recipeServings.invalid &&
              (form.controls.recipeServings.touched || form.controls.recipeServings.dirty)
            "
            type="number"
            name="servings"
            min="1"
            value="1"
            formControlName="recipeServings"
          />
          @if (
            form.controls.recipeServings.invalid &&
            (form.controls.recipeServings.touched || form.controls.recipeServings.dirty)
          ) {
            <span class="add-recipe__error">Il numero di porzioni è obbligatorio.</span>
          }
        </label>

        <div class="add-recipe__field add-recipe__field--toggle">
          <span class="add-recipe__label" id="favorite-label">Segna come preferita</span>
          <label class="add-recipe__toggle" aria-labelledby="favorite-label">
            <input class="add-recipe__toggle-input" type="checkbox" formControlName="isFavourite" />
            <span class="add-recipe__toggle-track" aria-hidden="true">
              <span class="add-recipe__toggle-thumb"></span>
            </span>
            <span class="add-recipe__toggle-text">Favorite</span>
          </label>
        </div>

        <div class="add-recipe__field add-recipe__field--full">
          <div class="add-recipe__ingredients-header">
            <span class="add-recipe__label">Ingredienti</span>
            <button class="add-recipe__mini-cta" type="button" (click)="addIngredient()">
              <span aria-hidden="true">＋</span>
              <span>Aggiungi ingrediente</span>
            </button>
          </div>
          @if (ingredients.length >= 1) {
            <div class="add-recipe__ingredients" formArrayName="ingredients">
              @for (fg of ingredients.controls; track fg; let i = $index) {
                <div
                  class="add-recipe__ingredient-row"
                  [formGroupName]="i"
                  [class.add-recipe__ingredient-row--invalid]="isIngredientGroupInvalid(i)"
                >
                  <input
                    class="add-recipe__input"
                    [class.add-recipe__input--invalid]="isIngredientControlInvalid(i, 'name')"
                    type="text"
                    placeholder="Nome"
                    formControlName="name"
                  />
                  <input
                    class="add-recipe__input"
                    [class.add-recipe__input--invalid]="isIngredientControlInvalid(i, 'quantity')"
                    type="number"
                    min="1"
                    placeholder="Quantità"
                    formControlName="quantity"
                  />
                  <select
                    class="add-recipe__select"
                    [class.add-recipe__select--invalid]="isIngredientControlInvalid(i, 'unit')"
                    formControlName="unit"
                  >
                    <option value="">Unità</option>
                    <option value="g">g</option>
                    <option value="ml">ml</option>
                    <option value="tbsp">tbsp</option>
                    <option value="each">each</option>
                    <option value="pinch">pinch</option>
                    <option value="clove">clove</option>
                  </select>
                  <button
                    class="add-recipe__ghost"
                    type="button"
                    aria-label="Rimuovi ingrediente"
                    (click)="removeIngredient(i)"
                  >
                    ×
                  </button>
                </div>
                @if (shouldShowIngredientErrors(i)) {
                  <div class="add-recipe__ingredient-errors" aria-live="polite">
                    @if (isIngredientControlInvalid(i, 'name')) {
                      <span class="add-recipe__error">Il nome è obbligatorio.</span>
                    }
                    @if (isIngredientControlInvalid(i, 'quantity')) {
                      <span class="add-recipe__error">Inserisci una quantità valida.</span>
                    }
                    @if (isIngredientControlInvalid(i, 'unit')) {
                      <span class="add-recipe__error">Seleziona un'unità.</span>
                    }
                  </div>
                }
              }
            </div>
          } @else {
            <div class="add-recipe__ingredients-empty">
              <p>Aggiungi almeno un ingrediente per continuare.</p>
            </div>
          }
        </div>
      </div>

      <footer class="add-recipe__actions">
        <button class="btn btn--secondary" type="button" (click)="openConfirmDiscardDialog()">
          Annulla
        </button>
        <button class="btn btn--primary" type="submit" [disabled]="form.invalid">
          Salva ricetta
        </button>
      </footer>
    </form>
  </div>

  @if (snackbarMessage()) {
    <div class="add-recipe__snackbar" role="status" aria-live="polite">
      {{ snackbarMessage() }}
    </div>
  }
</section>

@if (confirmationDialog()) {
  <app-confirmation-dialog>
    <div dialogTitle>
      <h1>{{ confirmationDialog()?.title }}</h1>
    </div>
    <div dialogMessage>
      <p>{{ confirmationDialog()?.message }}</p>
    </div>
    <div dialogActions>
      <button class="btn btn--secondary" type="button" (click)="handleDialogDecision(false)">
        Continua a modificare
      </button>
      <button class="btn btn--primary" type="button" (click)="handleDialogDecision(true)">
        Scarta modifiche
      </button>
    </div>
  </app-confirmation-dialog>
}
